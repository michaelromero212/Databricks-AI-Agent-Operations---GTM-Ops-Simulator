{% extends "layout.html" %}

{% block title %}Dashboard - GTM Ops{% endblock %}
{% block page_title %}KPI Dashboard{% endblock %}
{% block page_subtitle %}Comprehensive performance analytics{% endblock %}

{% set active_page = 'dashboard' %}

{% block content %}
{% if error %}
<div class="alert alert-danger">
    <strong>Error loading data:</strong> {{ error }}
</div>
{% else %}

{% if summary %}
<!-- North Star Metrics -->
<div class="card">
    <div class="card-header">
        <h2>ðŸ“ˆ Overall Performance</h2>
        <p>Aggregated metrics across all agent runs</p>
    </div>
    <div class="card-body">
        <div class="metrics-grid">
            <div class="metric-card {% if summary.acceptance_rate >= 85 %}success{% else %}warning{% endif %}">
                <div class="metric-label">Task Accuracy</div>
                <div class="metric-value">{{ "%.1f"|format(summary.acceptance_rate) }}<span>%</span></div>
                <div class="metric-change">Target: â‰¥85%</div>
            </div>

            <div class="metric-card {% if summary.avg_rating >= 4.0 %}success{% else %}warning{% endif %}">
                <div class="metric-label">User Satisfaction</div>
                <div class="metric-value">{{ "%.2f"|format(summary.avg_rating) }}<span>/5</span></div>
                <div class="metric-change">Target: â‰¥4.0</div>
            </div>

            <div class="metric-card {% if summary.avg_resolution_time <= 5 %}success{% else %}warning{% endif %}">
                <div class="metric-label">Avg Resolution Time</div>
                <div class="metric-value">{{ "%.2f"|format(summary.avg_resolution_time) }}<span>s</span></div>
                <div class="metric-change">Target: â‰¤5s</div>
            </div>

            <div class="metric-card {% if summary.error_rate <= 2 %}success{% else %}danger{% endif %}">
                <div class="metric-label">Error Rate</div>
                <div class="metric-value">{{ "%.1f"|format(summary.error_rate) }}<span>%</span></div>
                <div class="metric-change">Target: â‰¤2%</div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
    <!-- A/B Test Chart -->
    {% if ab_comparison %}
    <div class="card">
        <div class="card-header">
            <h2>ðŸ§ª A/B Test Comparison</h2>
            <p>Agent A (baseline) vs Agent B (experimental)</p>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="abCompareChart"></canvas>
            </div>
            <div class="decision-box success" style="margin-top: 1rem;">
                âœ… <strong>Decision:</strong> Continue with Agent A (see experiments/ab_test.md)
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Task Type Breakdown -->
    {% if by_task %}
    <div class="card">
        <div class="card-header">
            <h2>ðŸ“‹ Performance by Task Type</h2>
            <p>Metrics breakdown by operation type</p>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="taskTypeChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Tables Row -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
    <!-- By Task Type Table -->
    {% if by_task %}
    <div class="card">
        <div class="card-header">
            <h2>ðŸ“Š Task Type Details</h2>
        </div>
        <div class="card-body" style="padding: 0;">
            <table>
                <thead>
                    <tr>
                        <th>Task Type</th>
                        <th>Volume</th>
                        <th>Accuracy</th>
                        <th>Satisfaction</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in by_task %}
                    <tr>
                        <td><code>{{ task.task_type }}</code></td>
                        <td>{{ task.total_tasks }}</td>
                        <td>
                            <span
                                class="badge {% if task.accuracy_pct >= 90 %}badge-success{% elif task.accuracy_pct >= 80 %}badge-warning{% else %}badge-danger{% endif %}">
                                {{ "%.1f"|format(task.accuracy_pct) }}%
                            </span>
                        </td>
                        <td>{{ "%.2f"|format(task.avg_satisfaction) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- By Lead Source Table -->
    {% if by_source %}
    <div class="card">
        <div class="card-header">
            <h2>ðŸŽ¯ GTM Analysis: By Lead Source</h2>
        </div>
        <div class="card-body" style="padding: 0;">
            <table>
                <thead>
                    <tr>
                        <th>Lead Source</th>
                        <th>Volume</th>
                        <th>Accuracy</th>
                    </tr>
                </thead>
                <tbody>
                    {% for source in by_source %}
                    <tr>
                        <td>{{ source.lead_source }}</td>
                        <td>{{ source.volume }}</td>
                        <td>
                            <span
                                class="badge {% if source.accuracy >= 90 %}badge-success{% elif source.accuracy >= 80 %}badge-warning{% else %}badge-danger{% endif %}">
                                {{ source.accuracy }}%
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<!-- Daily Trends -->
{% if trends %}
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <h2>ðŸ“… Daily Trends</h2>
        <p>Time-series performance metrics</p>
    </div>
    <div class="card-body">
        <div class="chart-container">
            <canvas id="trendsChart"></canvas>
        </div>
    </div>
</div>
{% endif %}

{% endif %}
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    {% if ab_comparison %}
    // A/B Comparison Chart
    new Chart(document.getElementById('abCompareChart'), {
        type: 'bar',
        data: {
            labels: ['Accuracy %', 'Satisfaction', 'Avg Time (s)', 'Error Rate %'],
            datasets: [
                {
                    label: 'Agent A',
                    data: [{{ ab_comparison[0].accuracy_pct }}, {{ ab_comparison[0].avg_satisfaction }}, {{ ab_comparison[0].avg_resolution_time }}, {{ ab_comparison[0].error_rate }}],
        backgroundColor: '#10b981',
        borderRadius: 4
            },
        {% if ab_comparison | length > 1 %}
    {
        label: 'Agent B',
            data: [{{ ab_comparison[1].accuracy_pct }}, {{ab_comparison[1].avg_satisfaction}}, {{ab_comparison[1].avg_resolution_time}}, {{ab_comparison[1].error_rate}}],
    backgroundColor: '#f59e0b',
        borderRadius: 4
            }
    {% endif %}
        ]
    },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                plugins: { legend: { position: 'top'}},
        scales: {
            y: { beginAtZero: true, grid: { color: '#f1f5f9'}},
            x: { grid: { display: false}}
        }
    }
});
    {% endif %}

    {% if by_task %}
    // Task Type Chart
    new Chart(document.getElementById('taskTypeChart'), {
        type: 'doughnut',
        data: {
            labels: [{% for t in by_task %}'{{ t.task_type }}'{% if not loop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            data: [{% for t in by_task %}{{ t.total_tasks }}{% if not loop.last %}, {% endif %} {% endfor %}],
    backgroundColor: ['#1b3a4b', '#ff6f00', '#10b981', '#3b82f6', '#8b5cf6'],
        borderWidth: 0
        }]
    },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                plugins: {
            legend: { position: 'right' }
        }
    }
});
    {% endif %}

    {% if trends %}
    // Trends Chart
    new Chart(document.getElementById('trendsChart'), {
        type: 'line',
        data: {
            labels: [{% for t in trends %}'{{ t.date }}'{% if not loop.last %}, {% endif %}{% endfor %}],
        datasets: [
        {
            label: 'Accuracy %',
            data: [{% for t in trends %}{{ "%.1f"| format(t.accuracy_pct) }}{% if not loop.last %}, {% endif %} {% endfor %}],
    borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
            fill: true,
                tension: 0.3
            },
    {
        label: 'Tasks',
            data: [{% for t in trends %} {{t.total_tasks}} {% if not loop.last %}, {% endif %} {% endfor %}],
    borderColor: '#1b3a4b',
        backgroundColor: 'transparent',
            tension: 0.3,
                yAxisID: 'y1'
            }
        ]
    },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
        plugins: { legend: { position: 'top'}},
        scales: {
            y: { beginAtZero: true, max: 100, position: 'left', grid: { color: '#f1f5f9'}},
            y1: { beginAtZero: true, position: 'right', grid: { display: false}},
            x: { grid: { display: false}}
        }
    }
});
    {% endif %}
</script>
{% endblock %}