{% extends "layout.html" %}

{% block title %}Overview - GTM Ops{% endblock %}
{% block page_title %}Performance Overview{% endblock %}
{% block page_subtitle %}Real-time agent performance and GTM insights{% endblock %}

{% set active_page = 'home' %}

{% block content %}
{% if error %}
<div class="alert alert-danger">
    <strong>Error loading data:</strong> {{ error }}
</div>
{% endif %}

{% if summary %}
<!-- Quick Actions -->
<div class="actions-grid">
    <a href="/upload" class="action-card">
        <div class="icon">üß™</div>
        <div class="label">Test Agent</div>
        <div class="description">Upload data for AI analysis</div>
    </a>
    <a href="/dashboard" class="action-card">
        <div class="icon">üìà</div>
        <div class="label">Full Dashboard</div>
        <div class="description">Detailed metrics & trends</div>
    </a>
    <a href="/explorer" class="action-card">
        <div class="icon">üîç</div>
        <div class="label">SQL Explorer</div>
        <div class="description">Query the data directly</div>
    </a>
</div>

<!-- Key Metrics -->
<div class="card">
    <div class="card-header">
        <h2>üìä Performance Snapshot</h2>
        <p>Key metrics at a glance</p>
    </div>
    <div class="card-body">
        <div class="metrics-grid">
            <div class="metric-card {% if summary.acceptance_rate >= 85 %}success{% else %}warning{% endif %}">
                <div class="metric-label">Accuracy</div>
                <div class="metric-value">{{ "%.1f"|format(summary.acceptance_rate) }}<span>%</span></div>
                <div class="metric-change {% if summary.acceptance_rate >= 85 %}positive{% else %}negative{% endif %}">
                    Target: ‚â•85%
                </div>
            </div>

            <div class="metric-card {% if summary.avg_rating >= 4.0 %}success{% else %}warning{% endif %}">
                <div class="metric-label">Satisfaction</div>
                <div class="metric-value">{{ "%.2f"|format(summary.avg_rating) }}<span>/5</span></div>
                <div class="metric-change {% if summary.avg_rating >= 4.0 %}positive{% else %}negative{% endif %}">
                    Target: ‚â•4.0
                </div>
            </div>

            <div class="metric-card {% if summary.avg_resolution_time <= 5 %}success{% else %}warning{% endif %}">
                <div class="metric-label">Avg Response</div>
                <div class="metric-value">{{ "%.1f"|format(summary.avg_resolution_time) }}<span>s</span></div>
                <div
                    class="metric-change {% if summary.avg_resolution_time <= 5 %}positive{% else %}negative{% endif %}">
                    Target: ‚â§5s
                </div>
            </div>

            <div class="metric-card accent">
                <div class="metric-label">Total Runs</div>
                <div class="metric-value">{{ summary.total_runs|int }}</div>
                <div class="metric-change">{{ summary.unique_users|int }} active users</div>
            </div>
        </div>
    </div>
</div>

<!-- Two Column Layout -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
    <!-- A/B Test Summary -->
    {% if ab_comparison %}
    <div class="card">
        <div class="card-header">
            <h2>üß™ A/B Test Results</h2>
            <p>Agent version comparison</p>
        </div>
        <div class="card-body">
            <div class="chart-container small">
                <canvas id="abChart"></canvas>
            </div>
            <div class="decision-box success" style="margin-top: 1rem;">
                ‚úÖ <strong>Decision:</strong> Agent A outperforms B on key metrics
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Lead Source Performance -->
    <div class="card">
        <div class="card-header">
            <h2>üìà Performance by Source</h2>
            <p>Accuracy by lead source</p>
        </div>
        <div class="card-body">
            <div class="chart-container small">
                <canvas id="sourceChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="card">
    <div class="card-header">
        <h2>üïê Recent Activity</h2>
        <p>Latest agent interactions</p>
    </div>
    <div class="card-body" style="padding: 0;">
        {% if recent_activity %}
        <table>
            <thead>
                <tr>
                    <th>Task Type</th>
                    <th>User</th>
                    <th>Outcome</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
                {% for run in recent_activity %}
                <tr>
                    <td><code>{{ run.task_type }}</code></td>
                    <td>{{ run.user_id }}</td>
                    <td>
                        <span
                            class="badge {% if run.outcome == 'Accepted' %}badge-success{% else %}badge-danger{% endif %}">
                            {{ run.outcome }}
                        </span>
                    </td>
                    <td>{{ "%.1f"|format(run.resolution_time_seconds) }}s</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
</div>

{% else %}
<div class="card">
    <div class="card-body" style="text-align: center; padding: 3rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
        <h2>No Data Available</h2>
        <p style="color: var(--gray-500);">Upload sample data or test the agent to generate metrics.</p>
        <a href="/upload" class="btn btn-accent btn-lg" style="margin-top: 1rem;">Test Agent</a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if ab_comparison and top_sources %}
<script>
    // A/B Test Chart
    const abCtx = document.getElementById('abChart').getContext('2d');
    new Chart(abCtx, {
        type: 'bar',
        data: {
            labels: [{% for v in ab_comparison %}'Agent {{ v.agent_version }}'{% if not loop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Accuracy %',
            data: [{% for v in ab_comparison %}{{ "%.1f"| format(v.accuracy_pct) }}{% if not loop.last %}, {% endif %} {% endfor %}],
    backgroundColor: ['#10b981', '#f59e0b'],
        borderRadius: 6
        }]
    },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                    max: 100,
                        grid: { color: '#f1f5f9' }
            },
            x: {
                grid: { display: false }
            }
        }
    }
});

    // Source Chart
    const sourceCtx = document.getElementById('sourceChart').getContext('2d');
    new Chart(sourceCtx, {
        type: 'bar',
        data: {
            labels: [{% for s in top_sources %}'{{ s.lead_source|truncate(15) }}'{% if not loop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Accuracy %',
            data: [{% for s in top_sources %}{{ s.accuracy }}{% if not loop.last %}, {% endif %} {% endfor %}],
    backgroundColor: '#1b3a4b',
        borderRadius: 6
        }]
    },
    options: {
        indexAxis: 'y',
            responsive: true,
                maintainAspectRatio: false,
                    plugins: {
            legend: { display: false }
        },
        scales: {
            x: {
                beginAtZero: true,
                    max: 100,
                        grid: { color: '#f1f5f9' }
            },
            y: {
                grid: { display: false }
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}